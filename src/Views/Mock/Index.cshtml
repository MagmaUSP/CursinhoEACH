@model IEnumerable<CursinhoEACH.DTO.MockDTO>
@{
    ViewData["Title"] = "Simulados";
    var qCodigo = ViewData["FiltroCodigo"] as string;
    var qData = ViewData["FiltroData"] as string;
    var qTurma = ViewData["FiltroTurma"] as string;
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<form method="get" class="mb-2" autocomplete="off">
    <div class="row g-2 align-items-end">
        <div class="col-12 col-md-3">
            <label for="codigo" class="form-label">Código</label>
            <input type="text" class="form-control" id="codigo" name="codigo" maxlength="30" value="@qCodigo" />
        </div>
        <div class="col-12 col-md-3">
            <label for="data" class="form-label">Data</label>
            <input type="text" class="form-control" id="data" name="data" inputmode="numeric" maxlength="10" autocomplete="off" pattern="^\d{2}\/\d{2}\/\d{4}$" title="Formato: dd/mm/aaaa" value="@qData" placeholder="dd/mm/aaaa" />
        </div>
        <div class="col-12 col-md-3">
            <label for="turma" class="form-label">Turma</label>
            <input type="text" class="form-control" id="turma" name="turma" maxlength="50" value="@qTurma" />
        </div>
        <div class="col-12 col-md-3 d-flex gap-2 justify-content-end">
            <button type="submit" class="btn text-white btn-brand btn-no-focus">Filtrar</button>
            <a asp-action="Index" class="btn btn-outline-secondary btn-no-focus">Limpar</a>
        </div>
    </div>
</form>

<hr class="my-3" />

<table class="table table-hover align-middle">
    <thead>
        <tr>
            <th>Código</th>
            <th>Data</th>
            <th>Turma</th>
            <th class="text-end">Ações</th>
        </tr>
    </thead>
    <tbody>
        @foreach(var item in Model)
        {
        <tr>
            <td>@item.Codigo</td>
            <td>@item.Data.ToString("dd/MM/yyyy")</td>
            <td>@item.Turma</td>
            <td class="text-end">
                <a href="/Mock/@item.Id" class="btn btn-secondary text-white btn-icon-square btn-no-focus rounded me-1" title="Visualizar" aria-label="Visualizar">
                    <svg class="icon" aria-hidden="true" focusable="false"><use href="#i-search"></use></svg>
                </a>
            </td>
        </tr>
        }
        @if(!Model.Any())
        {
            <tr><td colspan="4" class="text-center text-muted">Nenhum simulado encontrado.</td></tr>
        }
    </tbody>
</table>

@section Scripts {
    <script>
        (function(){
            // Máscara de data
            const input = document.getElementById('data');
            if(input){
                function maskDate(v){
                    v = (v||'').replace(/\D/g,'').slice(0,8);
                    let r='';
                    if(v.length>0) r+=v.slice(0,2);
                    if(v.length>=3) r+='/'+v.slice(2,4);
                    if(v.length>=5) r+='/'+v.slice(4,8);
                    return r;
                }
                input.addEventListener('input', function(){ this.value = maskDate(this.value); });
            }

            // Script para adicionar parâmetro de retorno
            const here = location.pathname + location.search;
            document.querySelectorAll('a[href^="/Mock/"]').forEach(a => {
                try {
                    const u = new URL(a.getAttribute('href'), location.origin);
                    if (!/^\/Mock\/\d+$/i.test(u.pathname)) return;
                    const sp = u.searchParams;
                    if (!sp.has('return')) {
                        sp.set('return', here);
                        u.search = '?' + sp.toString();
                        a.setAttribute('href', u.pathname + u.search);
                    }
                } catch {}
            });
        })();
    </script>
}