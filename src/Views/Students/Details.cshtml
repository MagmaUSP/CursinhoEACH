@model CursinhoEACH.DTO.StudentProfileDTO
@{
    ViewData["Title"] = "Detalhes do Aluno";

    // Cálculos para o Gráfico de Questões (Pizza/Conic)
    double degCertas = (double)Model.QtdCertas / (Model.TotalQuestoes > 0 ? Model.TotalQuestoes : 1) * 360;
    double degErradas = (double)Model.QtdErradas / (Model.TotalQuestoes > 0 ? Model.TotalQuestoes : 1) * 360;
    // O restante é branco
    
    string gradientQuestoes = $"conic-gradient(#5492ca 0deg {degCertas.ToString("F0", System.Globalization.CultureInfo.InvariantCulture)}deg, #ef7b1b {degCertas.ToString("F0", System.Globalization.CultureInfo.InvariantCulture)}deg {(degCertas + degErradas).ToString("F0", System.Globalization.CultureInfo.InvariantCulture)}deg, #0b2440 {(degCertas + degErradas).ToString("F0", System.Globalization.CultureInfo.InvariantCulture)}deg 360deg)";

    // Cálculos para o Gráfico de Presença
    double degPresenca = Model.PercPresenca * 3.6; // 100% = 360deg
    string gradientPresenca = $"conic-gradient(#5492ca 0deg {degPresenca.ToString("F0", System.Globalization.CultureInfo.InvariantCulture)}deg, #ef7b1b {degPresenca.ToString("F0", System.Globalization.CultureInfo.InvariantCulture)}deg 360deg)";

    double percCertasGlobal = Model.TotalQuestoes > 0 ? (double)Model.QtdCertas/Model.TotalQuestoes * 100 : 0;
    double percErradasGlobal = Model.TotalQuestoes > 0 ? (double)Model.QtdErradas/Model.TotalQuestoes * 100 : 0;
    double percBrancoGlobal = Model.TotalQuestoes > 0 ? (double)Model.QtdBranco/Model.TotalQuestoes * 100 : 0;
}

<div class="mb-3">
    <a class="btn btn-outline-secondary btn-no-focus" href="/Students">Voltar</a>
</div>
<h4 class="mb-1">@Model.Nome</h4>
<p class="text-muted mb-4">CPF: @Model.CPF | Email: @Model.Email | Telefone: @Model.Telefone | Turma: @Model.Turma</p>

@if (Model.PercPresenca > 0.0)
{
    <div class="d-flex flex-wrap justify-content-center align-items-start" style="gap:5rem;">
        <div style="display:flex;flex-direction:column;gap:0.75rem;align-items:flex-start;">
            <h6 class="mb-0">Desempenho (Questões)</h6>
            <div class="d-flex align-items-start gap-4">
                <div class="rounded-circle border position-relative"
                     style="width:240px;height:240px;display:flex;align-items:center;justify-content:center;font-size:0.9rem;background:@gradientQuestoes;">
                </div>
          
                <div class="flex-grow-1" style="min-width:220px;">
                    <table class="table table-sm mb-0" style="max-width:260px;">
                        <thead>
                            <tr><th>Categoria</th><th class="text-end">%</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><span class="badge" style="background:#5492ca">&nbsp;</span> Certas</td><td class="text-end">@percCertasGlobal.ToString("F1")%</td></tr>
                            <tr><td><span class="badge" style="background:#ef7b1b">&nbsp;</span> Erradas</td><td class="text-end">@percErradasGlobal.ToString("F1")%</td></tr>
                            <tr><td><span class="badge" style="background:#0b2440">&nbsp;</span> Em branco</td><td class="text-end">@percBrancoGlobal.ToString("F1")%</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:0.75rem;align-items:flex-start;">
            <h6 class="mb-0">Presença (Aulas e Simulados)</h6>
            <div class="d-flex align-items-start gap-4">
                <div class="rounded-circle border position-relative"
                     style="width:240px;height:240px;display:flex;align-items:center;justify-content:center;font-size:0.9rem;background:@gradientPresenca;">
                </div>
                <div class="flex-grow-1" style="min-width:220px;">
                    <table class="table table-sm mb-0" style="max-width:260px;">
                        <thead>
                            <tr><th>Status</th><th class="text-end">%</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><span class="badge" style="background:#5492ca">&nbsp;</span> Presente</td><td class="text-end">@Model.PercPresenca.ToString("F1")%</td></tr>
                            <tr><td><span class="badge" style="background:#ef7b1b">&nbsp;</span> Ausente</td><td class="text-end">@Model.PercAusencia.ToString("F1")%</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="alert alert-info mt-4 text-center">
        <p class="mb-0">Este aluno ainda não participou de nenhum simulado.</p>
    </div>
}

<div class="mt-5" id="alunoTabs">
    <ul class="nav nav-tabs mb-3" role="tablist" style="gap:.25rem;">
        <li class="nav-item" role="presentation">
            <button type="button" class="nav-link active" data-tab="materias">Desempenho por Matéria</button>
        </li>
        <li class="nav-item" role="presentation">
            <button type="button" class="nav-link" data-tab="simulados">Desempenho por Simulado</button>
        </li>
        <li class="nav-item" role="presentation">
            <button type="button" class="nav-link" data-tab="assiduidade">Assiduidade</button>
        </li>
    </ul>
    
    <div class="tab-content border rounded p-3 bg-white">
        
        <div id="tab-materias" class="tab-pane active">
            <div class="subjects-grid">
                @if (Model.DesempenhoPorMateria.Any())
                {
                    @foreach (var mat in Model.DesempenhoPorMateria)
                    {
                        <div class="subject-card">
                            <table class="table table-sm mb-0 w-100">
                                <thead><tr><th colspan="3" class="text-center">@mat.Materia</th></tr></thead>
                                <tbody>
                                    <tr><td>Total</td><td class="text-end">@mat.Total</td><td class="text-end"></td></tr>
                                    <tr><td>Certas</td><td class="text-end">@mat.Certas</td><td class="text-end">@mat.PercCertas.ToString("F0")%</td></tr>
                                    <tr><td>Erradas</td><td class="text-end">@mat.Erradas</td><td class="text-end">@mat.PercErradas.ToString("F0")%</td></tr>
                                    <tr><td>Branco</td><td class="text-end">@mat.Branco</td><td class="text-end">@mat.PercBranco.ToString("F0")%</td></tr>
                                </tbody>
                            </table>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted p-3">Nenhum dado de desempenho por matéria encontrado.</p>
                }
            </div>
        </div>

        <div id="tab-simulados" class="tab-pane d-none">
            <div class="simulados-list">
                @if (Model.HistoricoSimulados.Any())
                {
                    @foreach(var sim in Model.HistoricoSimulados)
                    {
                        <div class="simulado-item">
                            <button type="button" class="simulado-header" aria-expanded="false">
                                <span class="simulado-title">@sim.Titulo - @sim.Data.ToString("dd/MM/yyyy")</span>
                                <span class="simulado-meta">Média: @sim.Media.ToString("F2") | Acertos: @sim.Acertos</span>
                                <span class="simulado-arrow" aria-hidden="true">&#9660;</span>
                            </button>
                            <div class="simulado-details d-none">
                                <h6 class="small fw-semibold mb-2">Resumo Geral</h6>
                                <table class="table table-sm mb-3">
                                    <thead class="table-light small"><tr><th scope="col">Indicador</th><th class="text-end" scope="col">Valor</th><th class="text-end" scope="col">%</th></tr></thead>
                                    <tbody class="small">
                                        <tr><td>Total de questões</td><td class="text-end">@sim.TotalQuestoes</td><td class="text-end"></td></tr>
                                        <tr><td>Questões certas</td><td class="text-end">@sim.Acertos</td><td class="text-end">@((sim.TotalQuestoes > 0 ? (double)sim.Acertos/sim.TotalQuestoes*100 : 0).ToString("F1"))%</td></tr>
                                        <tr><td>Questões erradas</td><td class="text-end">@sim.Erros</td><td class="text-end">@((sim.TotalQuestoes > 0 ? (double)sim.Erros/sim.TotalQuestoes*100 : 0).ToString("F1"))%</td></tr>
                                        <tr><td>Questões em branco</td><td class="text-end">@sim.Branco</td><td class="text-end">@((sim.TotalQuestoes > 0 ? (double)sim.Branco/sim.TotalQuestoes*100 : 0).ToString("F1"))%</td></tr>
                                    </tbody>
                                </table>
                                <h6 class="small fw-semibold mb-2">Por Matéria</h6>
                                <table class="table table-sm mb-2">
                                    <thead class="table-light small"><tr><th>Matéria</th><th class="text-end">Certas</th><th class="text-end">Erradas</th><th class="text-end">Em branco</th></tr></thead>
                                    <tbody class="small">
                                        @foreach(var m in sim.Materias)
                                        {
                                            <tr>
                                                <td>@m.Materia</td>
                                                <td class="text-end">@m.Certas (@m.PercCertas.ToString("F1")%)</td>
                                                <td class="text-end">@m.Erradas (@m.PercErradas.ToString("F1")%)</td>
                                                <td class="text-end">@m.Branco (@m.PercBranco.ToString("F1")%)</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted p-3">Nenhum simulado realizado.</p>
                }
            </div>
        </div>

        <div id="tab-assiduidade" class="tab-pane d-none">
            <div class="table-responsive">
                <table class="table table-sm mb-0" id="assiduidadeTabela">
                    <thead class="table-light small">
                        <tr>
                            <th>Matéria</th>
                            <th>Professor</th>
                            <th class="text-end">Presença (Aulas)</th>
                            <th class="text-end">%</th>
                        </tr>
                    </thead>
                    <tbody class="small">
                        @if(Model.AssiduidadePorMateria.Any())
                        {
                            @foreach(var ass in Model.AssiduidadePorMateria)
                            {
                                <tr>
                                    <td>@ass.Materia</td>
                                    <td>@ass.Professor</td>
                                    <td class="text-end">@ass.Presencas / @ass.AulasDadas</td>
                                    <td class="text-end">@ass.Porcentagem.ToString("F1")%</td>
                                </tr>
                            }
                        }
                        else
                        {
                             <tr><td colspan="4" class="text-center text-muted">Sem registros de aulas detalhados por matéria.</td></tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function(){
    const buttons = document.querySelectorAll('#alunoTabs [data-tab]');
    const panes = {
        materias: document.getElementById('tab-materias'),
        simulados: document.getElementById('tab-simulados'),
        assiduidade: document.getElementById('tab-assiduidade')
    };

    buttons.forEach(btn => {
        btn.addEventListener('click', () => {
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const target = btn.getAttribute('data-tab');
            Object.entries(panes).forEach(([k, el]) => {
                if(!el) return;
                if(k === target){
                    el.classList.remove('d-none');
                    el.classList.add('active');
                } else {
                    el.classList.add('d-none');
                    el.classList.remove('active');
                }
            });
        });
    });
})();

(function(){
    const items = document.querySelectorAll('#tab-simulados .simulado-item');
    items.forEach(item => {
        const header = item.querySelector('.simulado-header');
        const details = item.querySelector('.simulado-details');
        if(!header || !details) return;
        header.addEventListener('click', () => {
            const open = item.classList.toggle('open');
            details.classList.toggle('d-none');
            header.setAttribute('aria-expanded', open ? 'true' : 'false');
        });
    });
})();
</script>
}