@model CursinhoEACH.DTO.StudentsIndexViewModel
@{ 
    ViewData["Title"] = "Alunos"; 

    // 1. Gráfico de Questões
    double qCertas = Model.Dashboard.PercCertas;
    double qErradas = Model.Dashboard.PercErradas;
    double qBranco = Model.Dashboard.PercBranco;
    
    double degCertas = qCertas * 3.6;
    double degErradas = qErradas * 3.6;
    
    // Lógica: Se tem dados, usa gradiente. Se não, usa cinza.
    string bgQuestoes = Model.Dashboard.TotalQuestoesRespondidas > 0 
        ? $"conic-gradient(#5492ca 0deg {degCertas.ToString("F0", System.Globalization.CultureInfo.InvariantCulture)}deg, #ef7b1b {degCertas.ToString("F0", System.Globalization.CultureInfo.InvariantCulture)}deg {(degCertas + degErradas).ToString("F0", System.Globalization.CultureInfo.InvariantCulture)}deg, #0b2440 {(degCertas + degErradas).ToString("F0", System.Globalization.CultureInfo.InvariantCulture)}deg 360deg)"
        : "#e9ecef"; // Cinza claro

    // 2. Gráfico de Presença
    double pPresenca = Model.Dashboard.PercPresenca;
    double pAusencia = Model.Dashboard.PercAusencia;
    double degPresenca = pPresenca * 3.6;

	string bgPresenca = Model.Dashboard.TotalOportunidadesPresenca > 0
        ? $"conic-gradient(#5492ca 0deg {degPresenca.ToString("F0", System.Globalization.CultureInfo.InvariantCulture)}deg, #ef7b1b {degPresenca.ToString("F0", System.Globalization.CultureInfo.InvariantCulture)}deg 360deg)"
        : "#e9ecef"; // Cinza claro
	int currentYear = DateTime.UtcNow.Year;
}

<div class="mb-4" id="chartsWrapper">
	<div class="d-flex flex-wrap justify-content-center align-items-start" style="gap:5rem;">
		
        <!-- GRÁFICO 1: DESEMPENHO -->
		<div style="display:flex;flex-direction:column;gap:0.75rem;align-items:flex-start;">
			<h6 class="mb-0">Desempenho Geral (Questões)</h6>
			<div class="d-flex align-items-start gap-4">
				<div id="chartQuestoes"
					 class="rounded-circle border position-relative"
					 style="width:240px;height:240px;display:flex;align-items:center;justify-content:center;font-size:0.9rem;background:@bgQuestoes;">
                     @if(Model.Dashboard.TotalQuestoesRespondidas == 0 && Model.Dashboard.PercPresenca == 0) { <span class="text-muted small">Sem dados</span> }
				</div>
				<div class="flex-grow-1" style="min-width:220px;">
					<table class="table table-sm mb-0" style="max-width:260px;">
						<thead>
							<tr><th>Categoria</th><th class="text-end">%</th></tr>
						</thead>
						<tbody id="legendQuestoes">
							<tr><td><span class="badge" style="background:#5492ca">&nbsp;</span> Certas</td><td class="text-end">@qCertas.ToString("F1")%</td></tr>
							<tr><td><span class="badge" style="background:#ef7b1b">&nbsp;</span> Erradas</td><td class="text-end">@qErradas.ToString("F1")%</td></tr>
							<tr><td><span class="badge" style="background:#0b2440">&nbsp;</span> Em branco</td><td class="text-end">@qBranco.ToString("F1")%</td></tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>

        <!-- GRÁFICO 2: PRESENÇA -->
		<div style="display:flex;flex-direction:column;gap:0.75rem;align-items:flex-start;">
			<h6 class="mb-0">Presença (Aulas e Simulados)</h6>
			<div class="d-flex align-items-start gap-4">
				<div id="chartPresenca"
					 class="rounded-circle border position-relative"
					 style="width:240px;height:240px;display:flex;align-items:center;justify-content:center;font-size:0.9rem;background:@bgPresenca;">
                     @if(Model.Dashboard.TotalOportunidadesPresenca == 0) { <span class="text-muted small">Sem dados</span> }
				</div>
				<div class="flex-grow-1" style="min-width:220px;">
					<table class="table table-sm mb-0" style="max-width:260px;">
						<thead>
							<tr><th>Status</th><th class="text-end">%</th></tr>
						</thead>
						<tbody id="legendPresenca">
							<tr><td><span class="badge" style="background:#5492ca">&nbsp;</span> Presente</td><td class="text-end">@pPresenca.ToString("F1")%</td></tr>
							<tr><td><span class="badge" style="background:#ef7b1b">&nbsp;</span> Ausente</td><td class="text-end">@pAusencia.ToString("F1")%</td></tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>

	</div>
</div>

<hr class="my-4" />

<!-- FILTROS -->
<form method="get" class="mb-3" autocomplete="off">
    <div class="row g-2 align-items-end">
        <div class="col-12 col-md-3">
            <label for="fCpf" class="form-label">CPF</label>
			<input type="text" class="form-control cpf-mask" id="fCpf" name="cpf" value="@ViewData["FiltroCpf"]" maxlength="14" />
        </div>
        <div class="col-12 col-md-3">
            <label for="fNome" class="form-label">Nome</label>
			<input type="text" class="form-control" id="fNome" name="nome" value="@ViewData["FiltroNome"]" maxlength="100" />
        </div>
        <div class="col-12 col-md-3">
            <label for="fEmail" class="form-label">Email</label>
			<input type="text" class="form-control" id="fEmail" name="email" value="@ViewData["FiltroEmail"]" maxlength="100" />
        </div>
		<div class="col-12 col-md-3">
			<label for="fTurmaPeriodo" class="form-label">Período</label>
			@{
				var fp = ViewData["FiltroPeriodo"] as string;
			}
			<select class="form-select" id="fTurmaPeriodo" name="periodo">
				@if (string.IsNullOrEmpty(fp)) { <option value="" selected>Todos</option> } else { <option value="">Todos</option> }
				@if (fp == "M") { <option value="M" selected>Matutino</option> } else { <option value="M">Matutino</option> }
				@if (fp == "V") { <option value="V" selected>Vespertino</option> } else { <option value="V">Vespertino</option> }
				@if (fp == "N") { <option value="N" selected>Noturno</option> } else { <option value="N">Noturno</option> }
			</select>
		</div>
		<div class="col-12 col-md-3">
			<label for="fTurmaAno" class="form-label">Ano</label>
			@{
				var fa = ViewData["FiltroAno"]?.ToString();
			}
			<select class="form-select" id="fTurmaAno" name="ano">
				@if (string.IsNullOrEmpty(fa)) { <option value="" selected>Todos</option> } else { <option value="">Todos</option> }
				@for (int y = currentYear + 1; y >= 2024; y--) {
					@if (fa == y.ToString()) { <option value="@y" selected>@y</option> } else { <option value="@y">@y</option> }
				}
			</select>
		</div>
		<div class="col-12 d-flex gap-2 justify-content-end">
			<button type="submit" id="btnFiltrarAlunos" class="btn text-white btn-brand btn-no-focus">Filtrar</button>
			<button type="button" id="btnLimparAlunos" class="btn btn-outline-secondary btn-no-focus">Limpar</button>
		</div>
    </div>
</form>

<!-- TABELA -->
<table class="table table-hover align-middle" id="tblAlunos">
	<thead>
		<tr>
			<th>CPF</th>
			<th>Nome</th>
			<th class="text-end">Presença em Aulas %</th>
			<th class="text-end">Presença em Simulados %</th>
			<th class="text-end">Ações</th>
		</tr>
	</thead>
    <tbody>
        @if(Model.Students != null && Model.Students.Any())
        {
            foreach(var item in Model.Students)
            {
                <tr>
			        <td>@item.CPF</td>
			        <td>@item.Nome</td>
			        <td class="text-end">@item.IAA.ToString("F1")%</td>
			        <td class="text-end">@item.IAS.ToString("F1")%</td>
			        <td class="text-end">
				        <a href="/Students/@item.CPF" class="btn btn-secondary text-white btn-icon-square btn-no-focus rounded" title="Detalhes" aria-label="Detalhes">
					        <svg class="icon" aria-hidden="true" focusable="false"><use href="#i-search"></use></svg>
				        </a>
			        </td>
		        </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="5" class="text-center text-muted">Nenhum aluno encontrado.</td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
	<script>
	(function(){
		const btnLimpar = document.getElementById('btnLimparAlunos');
		if(btnLimpar){
			btnLimpar.addEventListener('click', ()=>{
				document.getElementById('fCpf').value='';
				document.getElementById('fNome').value='';
				document.getElementById('fEmail').value='';
				document.getElementById('fTurmaPeriodo').value='';
				document.getElementById('fTurmaAno').value='';
                document.forms[0].submit();
			});
		}
	})();
	</script>
}