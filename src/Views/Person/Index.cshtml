@model IEnumerable<CursinhoEACH.DTO.PersonDTO>

@{
    ViewData["Title"] = "Pessoas";
}

<p class="text-muted">Página para gerenciar pessoas do cursinho (Professores, Alunos e Responsáveis).</p>

<form method="get" class="mb-2" autocomplete="off">
    <div class="row g-2 align-items-end">
        <div class="col-12 col-md-3">
            <label for="cpf" class="form-label">CPF</label>
            <input type="text" class="form-control" id="cpf" name="cpf" value="@ViewData["FiltroCpf"]" placeholder="Apenas números" />
        </div>
        <div class="col-12 col-md-3">
            <label for="nome" class="form-label">Nome</label>
            <input type="text" class="form-control" id="nome" name="nome" value="@ViewData["FiltroNome"]" />
        </div>
        <div class="col-12 col-md-3">
            <label for="email" class="form-label">Email</label>
            <input type="text" class="form-control" id="email" name="email" value="@ViewData["FiltroEmail"]" />
        </div>
        <div class="col-12 col-md-3">
            <label for="papel" class="form-label">Papel</label>
            <select class="form-select" id="papel" name="papel">
                <option value="">Todos</option>
                <option value="Aluno" selected="@(ViewData["FiltroPapel"]?.ToString() == "Aluno")">Aluno</option>
                <option value="Professor" selected="@(ViewData["FiltroPapel"]?.ToString() == "Professor")">Professor</option>
                <option value="Responsável" selected="@(ViewData["FiltroPapel"]?.ToString() == "Responsável")">Responsável</option>
            </select>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-12 d-flex gap-2 justify-content-end">
            <button type="submit" class="btn text-white btn-brand btn-no-focus">Filtrar</button>
            <a asp-action="Index" class="btn btn-outline-secondary btn-no-focus">Limpar</a>
        </div>
    </div>
</form>

<hr class="my-3" />

<div class="d-flex justify-content-end align-items-center mb-2">
    <a asp-action="Create" class="btn text-white btn-brand btn-no-focus" role="button" title="Adicionar pessoa">
        Adicionar pessoa
    </a>
</div>

<table class="table table-hover align-middle">
    <thead>
        <tr>
            <th>Nome</th>
            <th>Email</th>
            <th>Papel</th>
            <th class="text-end">Ações</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var person in Model)
        {
            <tr>
                <td>@person.Nome</td>
                <td>@person.Email</td>
                <td>
                    @if(person.Papel == "Aluno") { <span class="badge bg-primary">Aluno</span> }
                    else if(person.Papel == "Professor") { <span class="badge bg-success">Professor</span> }
                    else { <span class="badge bg-secondary">Responsável</span> }
                </td>
                <td class="text-end">
                    <a asp-action="Details" asp-route-cpf="@person.CPF.Trim()" 
                       class="btn btn-sm btn-secondary text-white btn-icon-square btn-no-focus rounded me-1" 
                       title="Visualizar">
                         <svg class="icon" aria-hidden="true" focusable="false"><use href="#i-search"></use></svg>
                    </a>
                    
                    <button class="btn btn-sm btn-danger text-white btn-icon-square btn-no-focus rounded" title="Remover">
                        <svg class="icon" aria-hidden="true" focusable="false"><use href="#i-x"></use></svg>
                    </button>
                </td>
            </tr>
        }
        
        @if (!Model.Any())
        {
            <tr>
                <td colspan="4" class="text-center text-muted py-4">
                    Nenhuma pessoa encontrada com os filtros informados.
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script>
        (function(){
            const here = location.pathname + location.search;
            const links = document.querySelectorAll('a[href^="/Person/"]');
            links.forEach(a => {
                try {
                    const u = new URL(a.getAttribute('href'), location.origin);
                    if (!/^\/Person\/\d+$/i.test(u.pathname)) return;
                    const sp = u.searchParams;
                    if (!sp.has('return')) {
                        sp.set('return', here);
                        u.search = '?' + sp.toString();
                        a.setAttribute('href', u.pathname + u.search);
                    }
                } catch {}
            });
        })();
    </script>
}