@model CursinhoEACH.DTO.ClassDetailsDTO
@{ ViewData["Title"] = "Turma"; }

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show mt-2" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<input type="hidden" id="ClassKey" value="@Model.Key" />

<div class="card">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-12 col-md-4">
                <div class="fw-semibold small text-muted">Ano</div>
                <div>@Model.Ano</div>
            </div>
            <div class="col-12 col-md-4">
                <div class="fw-semibold small text-muted">Período</div>
                <div>@Model.PeriodoExtenso (@Model.Periodo)</div>
            </div>
            <div class="col-12 col-md-4">
                <div class="fw-semibold small text-muted">Capacidade</div>
                <input type="number" class="form-control form-control-sm" id="Capacidade" value="@Model.Capacidade" min="1" max="100" disabled />
            </div>
            <div class="col-12 col-md-4">
                <div class="fw-semibold small text-muted">Matriculados</div>
                <div id="MatriculadosValor">@Model.Matriculados</div>
            </div>
            <div class="col-12 col-md-4">
                <div class="fw-semibold small text-muted">Ocupação</div>
                <div class="d-flex flex-column">
                    <div class="progress" style="height:6px;">
                        <div class="progress-bar" id="ocupacaoBar" style="width:@Model.OcupacaoPorcentagem%;"></div>
                    </div>
                    <span class="small mt-1" id="ocupacaoPct">@Model.OcupacaoPorcentagem%</span>
                </div>
            </div>
        </div>
        <div class="mt-3 d-flex justify-content-end gap-2" id="actionsWrap">
            <button type="button" id="btnEditarCapacidade" class="btn btn-brand text-white btn-no-focus">Editar</button>
            <button type="button" id="btnSalvarCapacidade" class="btn btn-brand text-white btn-no-focus d-none">Salvar</button>
            <button type="button" id="btnCancelarCapacidade" class="btn btn-danger btn-no-focus d-none">Cancelar</button>
            <a asp-action="Index" class="btn btn-outline-secondary btn-no-focus" id="btnVoltar">Voltar</a>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
            // --- JS Original com Modificação para salvar no backend ---
            const inputCap = document.getElementById('Capacidade');
            const spanMatric = document.getElementById('MatriculadosValor');
            const bar = document.getElementById('ocupacaoBar');
            const pct = document.getElementById('ocupacaoPct');
            const btnEditar = document.getElementById('btnEditarCapacidade');
            const btnSalvar = document.getElementById('btnSalvarCapacidade');
            const btnCancelar = document.getElementById('btnCancelarCapacidade');
            const btnVoltar = document.getElementById('btnVoltar');
            const classKey = document.getElementById('ClassKey').value; // Chave para o backend

            if (inputCap && spanMatric && bar && pct && btnEditar && btnSalvar && btnCancelar && btnVoltar) {
                const min = Number(inputCap.min || 1);
                const max = Number(inputCap.max || 100);
                let originalCap = Number(inputCap.value || min);
                const matriculados = () => Number((spanMatric.textContent || '0').replace(/\D+/g,''));
                const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

                function recalc(){
                    const cap = clamp(Number(inputCap.value || originalCap), min, max);
                    const m = matriculados();
                    const ratio = cap>0 ? Math.min(1, m/cap) : 0;
                    const percent = Math.round(ratio*100);
                    bar.style.width = percent + '%';
                    pct.textContent = percent + '%';
                }

                function setEditing(on){
                    inputCap.disabled = !on;
                    btnEditar.classList.toggle('d-none', on);
                    btnSalvar.classList.toggle('d-none', !on);
                    btnCancelar.classList.toggle('d-none', !on);
                    btnVoltar.classList.toggle('d-none', on);
                    if(on){ 
                        originalCap = Number(inputCap.value); 
                        setTimeout(()=>{ inputCap.focus(); inputCap.select && inputCap.select(); },0);
                    }
                }

                btnEditar.addEventListener('click', ()=> setEditing(true));
                
                btnCancelar.addEventListener('click', ()=> { 
                    inputCap.value = String(originalCap); 
                    recalc(); 
                    setEditing(false); 
                });

                // AJAX PARA SALVAR
                btnSalvar.addEventListener('click', ()=> { 
                    const v = clamp(Number(inputCap.value || originalCap), min, max); 
                    
                    // Envia para o backend
                    fetch('/Class/UpdateCapacity', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key: classKey, capacidade: v })
                    }).then(res => {
                        if(res.ok) {
                            inputCap.value=String(v); 
                            originalCap=v; 
                            recalc(); 
                            setEditing(false);
                        } else {
                            alert('Erro ao salvar capacidade.');
                        }
                    });
                });

                inputCap.addEventListener('input', recalc);
                recalc();
            }

            // ... (Resto do script addReturn mantido igual) ...
                (function addReturn(){
                    const here = location.pathname + location.search;
                    document.querySelectorAll('a[href^="/Person/"]').forEach(a => {
                        try {
                            const u = new URL(a.getAttribute('href'), location.origin);
                            if(!/^\/Person\/\d+$/i.test(u.pathname)) return; // só detalhes
                            const sp = u.searchParams;
                            if(!sp.has('return')){ sp.set('return', here); u.search='?' + sp.toString(); a.setAttribute('href', u.pathname + u.search); }
                        } catch { /* ignora */ }
                    });
                })();
            })();
            
    </script>
}

    <div class="mt-4">
        <form asp-action="AddTeacher" method="post">
            <input type="hidden" name="Key" value="@Model.Key" />
            <div class="d-flex align-items-end flex-wrap gap-2 mb-3">
                <h6 class="mb-0 me-auto">Professores da turma</h6>
                <div class="d-flex align-items-end gap-2">
                    <div>
                        <label for="NovaMateria" class="form-label small mb-1">Matéria</label>
                        <select id="NovaMateria" name="Materia" class="form-select form-select-sm" style="min-width: 260px;" required>
                            <option value="" selected disabled>Selecione...</option>
                            <option value="Álgebra">Álgebra</option>
                            <option value="Geometria">Geometria</option>
                            <option value="História do Brasil">História do Brasil</option>
                            <option value="História Geral">História Geral</option>
                            <option value="Geografia do Brasil">Geografia do Brasil</option>
                            <option value="Geografia Geral">Geografia Geral</option>
                            <option value="Biologia">Biologia</option>
                            <option value="Química Orgânica">Química Orgânica</option>
                            <option value="Química Inorgânica">Química Inorgânica</option>
                            <option value="Física">Física</option>
                            <option value="Inglês">Inglês</option>
                            <option value="Atualidades">Atualidades</option>
                            <option value="Português">Português</option>
                            <option value="Redação">Redação</option>
                            <option value="Literatura">Literatura</option>
                        </select>
                    </div>
                    <div>
                        <label for="NovoProfessorCPF" class="form-label small mb-1">CPF</label>
                        <input type="text" id="NovoProfessorCPF" name="ProfessorCPF" class="form-control form-control-sm cpf-mask" placeholder="000.000.000-00" maxlength="14" required />
                    </div>
                    <div class="pt-4">
                        <button type="submit" id="btnAddProfessor" class="btn btn-brand text-white btn-no-focus btn-sm">Adicionar professor</button>
                    </div>
                </div>
            </div>
        </form>

        <table class="table table-sm table-hover">
            <thead>
                <tr>
                    <th>Matéria</th>
                    <th>Área</th>
                    <th>Professor</th>
                    <th class="text-end">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach(var teacher in Model.Teachers) {
                <tr>
                    <td>@teacher.Materia</td>
                    <td>@teacher.AreaExtenso</td>
                    <td>@teacher.Nome</td>
                    <td class="text-end">
                        <a href="/Person/@teacher.CPF" class="btn btn-secondary text-white btn-icon-square btn-no-focus rounded me-1" title="Detalhes" aria-label="Detalhes">
                            <svg class="icon" aria-hidden="true" focusable="false"><use href="#i-search"></use></svg>
                        </a>
                        <a asp-action="RemoveTeacher" asp-route-key="@Model.Key" asp-route-cpf="@teacher.CPF" class="btn btn-danger text-white btn-icon-square btn-no-focus rounded" title="Excluir" aria-label="Excluir" onclick="return confirm('Remover professor desta turma?');">
                            <svg class="icon" aria-hidden="true" focusable="false"><use href="#i-x"></use></svg>
                        </a>
                    </td>
                </tr>
                }
                @if(!Model.Teachers.Any()) {
                    <tr><td colspan="4" class="text-muted small">Nenhum professor alocado.</td></tr>
                }
            </tbody>
         </table>
    </div>

    <div class="mt-5">
        <div class="d-flex align-items-end flex-wrap gap-2 mb-3">
            <h6 class="mb-0 me-auto">Alunos da turma</h6>
        </div>
        <table class="table table-sm table-hover">
            <thead>
                <tr>
                    <th>CPF</th>
                    <th>Nome</th>
                    <th class="text-end">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach(var aluno in Model.Students) {
                <tr>
                    <td>@aluno.CPF</td>
                    <td>@aluno.Nome</td>
                    <td class="text-end">
                        <a href="/Person/@aluno.CPF" class="btn btn-secondary text-white btn-icon-square btn-no-focus rounded me-1" title="Detalhes" aria-label="Detalhes">
                            <svg class="icon" aria-hidden="true" focusable="false"><use href="#i-search"></use></svg>
                        </a>
                    </td>
                </tr>
                }
                @if(!Model.Students.Any()) {
                    <tr><td colspan="3" class="text-muted small">Nenhum aluno matriculado.</td></tr>
                }
            </tbody>
        </table>
    </div>