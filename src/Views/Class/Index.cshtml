@model IEnumerable<CursinhoEACH.DTO.ClassDTO>
@{
    ViewData["Title"] = "Turmas";
    int currentYear = DateTime.UtcNow.Year;
    int? filtroAno = ViewData["FiltroAno"] as int?;
    string filtroPeriodo = ViewData["FiltroPeriodo"] as string;
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<p class="text-muted">Gerencie turmas por ano e período.</p>

<form method="get" class="mb-2" autocomplete="off">
    <div class="row g-2 align-items-end">
        <div class="col-12 col-md-3">
            <label for="ano" class="form-label">Ano</label>
            <select class="form-select" id="ano" name="ano">
                <option value="">Todos</option>
                @for (int y = currentYear + 1; y >= 2015; y--) { 
                   <option value="@y" selected="@(filtroAno == y)">@y</option> 
                }
            </select>
        </div>
        <div class="col-12 col-md-3">
            <label for="periodo" class="form-label">Período</label>
            <select class="form-select" id="periodo" name="periodo">
                <option value="">Todos</option>
                <option value="M" selected="@(filtroPeriodo == "M")">Matutino</option>
                <option value="V" selected="@(filtroPeriodo == "V")">Vespertino</option>
                <option value="N" selected="@(filtroPeriodo == "N")">Noturno</option>
            </select>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-12 d-flex gap-2 justify-content-end">
            <button type="submit" class="btn text-white btn-brand btn-no-focus">Filtrar</button>
            <a asp-action="Index" class="btn btn-outline-secondary btn-no-focus">Limpar</a>
        </div>
    </div>
</form>

<hr class="my-3" />

<div class="d-flex justify-content-end align-items-center mb-2">
    <a asp-action="Create" class="btn text-white btn-add-person btn-no-focus" role="button" title="Adicionar turma">
        Adicionar turma
    </a>
</div>

<table class="table table-hover align-middle">
    <thead>
        <tr>
            <th>Ano</th>
            <th>Período</th>
            <th>Matriculados/Capacidade</th>
            <th class="text-end">Ações</th>
        </tr>
    </thead>
    <tbody>
        @foreach(var item in Model) {
        <tr>
            <td>@item.Ano</td>
            <td>@item.PeriodoExtenso</td>
            <td>
                <div class="d-flex flex-column">
                    <span>@item.Matriculados/@item.Capacidade</span>
                    <div class="progress" style="height:6px;">
                        <div class="progress-bar" style="width:@item.OcupacaoPorcentagem%;"></div>
                    </div>
                </div>
            </td>
            <td class="text-end">
                <a href="/Class/@item.Key" class="btn btn-secondary text-white btn-icon-square btn-no-focus rounded me-1" title="Visualizar" aria-label="Visualizar">
                    <svg class="icon" aria-hidden="true" focusable="false"><use href="#i-search"></use></svg>
                </a>
                <a asp-action="Delete" asp-route-key="@item.Key" onclick="return confirm('Tem certeza?');" class="btn btn-danger text-white btn-icon-square btn-no-focus rounded" title="Remover" aria-label="Remover">
                    <svg class="icon" aria-hidden="true" focusable="false"><use href="#i-x"></use></svg>
                </a>
            </td>
        </tr>
        }
        @if(!Model.Any()){
            <tr><td colspan="4" class="text-center text-muted">Nenhuma turma encontrada.</td></tr>
        }
    </tbody>
</table>